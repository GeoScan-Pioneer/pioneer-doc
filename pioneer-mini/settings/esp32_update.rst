Обновление прошивки ESP-32
==========================

Контроллер ESP-32 отвечает за передачу видеопотока и передачу команд управления с телефона на квадрокоптер.
Для обновления прошивки ESP-32, вам понадобиться специальная утилита. Данная инструкция объяснит процесс работы с ней.

.. attention:: Вышла новая версия прошивки ESP-32 необходимая для стабильной работы и поддержки ряда новых функций! Ознакомиться с изменениями можно в истории версий внизу страницы. 


Процесс обновления контроллера ESP-32
-------------------------------------

.. danger:: Перед началом обновления прошивки убедитесь, что версия автопилота: |fw_ap_mini|. В противном случае прошивка может привести к выходу квадрокоптера из строя. Проверить можно в Pioneer Station. Для этого подключите квадрокоптер по USB, в правом нижнем углу программы в строчке "Версия АП" должно быть 1.6.7747. При необходимости - выполните обновление.

:doc:`firmware_upgrade`


1. Подключите Пионер Мини к компьютеру через Micro-USB разъем.

.. figure:: media/esp32/copter-usb.jpg
   :align: center
   :scale: 50%

2. Нажмите кнопку включения,  левый светодиод должен начать моргать.


3. Скачайте архив ESPTOOL, в нем содержится утилита для прошивки контроллера ESP-32


`ESPTOOL с прошивкой ESP 0.4.5 и параметрами автопилота 0014 <https://disk.yandex.ru/d/ymscegzZ7uD4RA>`__

.. attention:: Рекомендуется запускать на ОС Windows 10.

4. Разархивируйте ZIP архив, нажав на него правой кнопкой мыши и выбрав "Извлечь все...".

.. figure:: media/esp32/esp-zip.jpg
   :align: center

5. Откройте разархивированную папку и запустите из неё файл runiterative.bat

.. attention:: Перед этим вам необходимо закрыть программу Pioneer Station, если она у вас открыта.


.. attention:: В файле par.properties содержатся параметры автопилота. Они загрузятся автоматически, в данной версии программы.


6. Дождитесь обновления прошивки ESP-32, она может занимать до 5 минут.

.. figure:: media/esp32/esptool-work1.jpg
   :align: center


7. После появления сообщения "Hard resetting via RTS pin..." закройте утилиту нажатием на "крестик".


.. attention:: Приложение не должно закрываться автоматически, дождитесь надписи указанной выше.

.. figure:: media/esp32/esptool-work2.png
   :align: center

8. Перезапустите Пионер Мини нажатием на кнопку включения.

.. figure:: media/esp32/copter-restart.jpg
   :align: center
   :scale: 50%

9. Квадрокоптер готов к работе.


.. attention:: Если процесс обновления не удаётся завершить из-за ошибки **>>>OFFSET_ERROR<<<** вам необходимо произвести перекалибровку акселерометра. Чтобы это сделать, перейдите на страницу :doc:`accel-mini`.

В ESPTOOL 2.0 в случае возникновение аналогичной проблемы надо нажать любую кнопку.


Проверка после обновления
--------------------------

Перед началом убедитесь:


1. Что параметры загружены верно.

Проверить загрузили ли вы конкретные параметры 0014 или нет, можно через номер борта, для этого отключите коптер по USB нажав кнопку "подключение", затем заново подключите, если у вас "номер борта" изменился на *2009*. (пример на снимке экрана ниже, там 501)
При работе с ESPTOOL 2.0 и pioneer_sdk номер борта должен поменяться на *2009*.

.. figure:: media/esp32/properties-test.PNG
   :align: center
   :scale: 50%

При необходимости можно загрузить по ссылке ниже или на странице :doc:`autopilot_parameters`

`Параметры автопилота 1.0.0014 для прошивки АП 1.6.7747 <https://disk.yandex.ru/d/LOHZoIZ45vNV2Q>`__


2. Что вы обновили прошивку ESP-32, как описано выше. Для проверки откройте Jump, в расширенных настройках включите отображение отладочной информации. В строке напротив "cur" должна быть надпись ["0.2.7"] или выше.


.. figure:: media/esp32/cur-version.png
   :align: center

Также проверить, прошло ли обновление успешно через имя WiFi сети. Если сеть называется "Pioneer_Mini" и после слова "Mini" отсуствует набор случайных цифр и букв, значит обновление не прошло.

После успешного обновления имя сети должно измениться например на "PioneerMini5afg415bb".


3. У вас установлено приложение Geoscan Jump последний версии. Номер версии можно проверить в самом приложении в вкладке "Расширенные настройки". Должна быть  версия "1.0 16" или выше.

.. figure:: media/esp32/jump-version.jpg
   :align: center
   :scale: 70%

.. attention:: В новой версии Jump кнопку START и STOP необходимо удерживать до тех пор, пока моторы не запустятся/остановятся.



Команда раннего тестирования
----------------------------

Хотите получить доступ к новым возможностям раньше остальных? Записывайтесь в нашу команду тестирования.

Если вы хотите принять участие, вам необходимо написать в `телеграмм аккаунт <https://t.me/geoscan_edu>`__. Через некоторое время, вам в ответном сообщении вышлют инструкцию для дальнейших действий.

Только для пользователей Пионер Мини!


История обновлений
------------------

09.02.22 вышла новая прошивка ESP-32 0.4.5 Для корректной работы квадрокоптера, вам обязательно нужно обновить прошивку данного контроллера.

**Список изменений версии 0.4.5**

*  Добавлена возможность записи видео с квадрокоптера на SD-карту.
*  Добавлена возможность подключения к внешней сети WiFi.
*  Выход в OpenSource
*  Исправлены баги предыдущих версий.

06.10.21 вышла новая прошивка ESP-32. 

**Новая версия прошивки ESP-32 и обновленный Geoscan Jump, качественно улучшают:**

* Скорость передачи видеопотока;

* Увеличено количество кадров в секунду;

* Скорость передачи команд управления;

* Стабильность WiFi соединения;

* Совместимость с большим количеством телефонов.

**Новая версия параметров автопилота версии 0014:**

* Улучшена стабильность взлета и посадки;

* Квадрокоптер быстрее отключается при переворотах и столкновениях;

* Управление в режимах полета Althold и Stabilize стало более отзывчивым;

* Убран баг с автозапуском LUA скрипта.












