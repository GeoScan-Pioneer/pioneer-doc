Настройка параметров автопилота
=================================

Параметры полета квадрокоптера в автоматическом режиме можно тонко настроить, используя программу :doc:`/pioneer_station/pioneer_station_main`. Для этого подключите "Пионер" к компьютеру следуя инструкции (:doc:`/pioneer_station/pioneer_station_upload`) и перейдите из вкладки "редактор кода" в "настройки параметров автопилота"

Для настройки "Пионер" должен быть подключен к компьютеру, его текущие параметры должны отображаться в правой части окна.

.. image:: media/autopilot.PNG
	:align: center

Перейдите во вкладку *"параметры автопилота"*. Для отображение полного списка параметров поставьте галочку в строке *"Все параметры"*. В первом столбце таблицы приведены названия параметров. Узнать, за что каждый из них отвечает, можно, посмотрев в крайний правый столбец. Во втором столбце отображаются текущие значения, присвоенные каждому из параметров. Если вы хотите поменять какое-либо из них, введите новое значение в столбец справа от текущего значения и нажмите Enter. 
Завершив редактирование, не забудьте сохранить изменения, нажав кнопку **сохранить изменения на автопилот** в виде стрелки.
 
Pioneer Station позволяет сохранять параметры, а также загружать их из файла. Для сохранения параметров нажмите на кнопку **сохранить в файл** и укажите путь для сохранения файла. Для загрузки параметров нажмите на кнопку **открыть из файла** в виде иконки с папкой и выберите необходимый файл. 

Дополнительно, в верхней части окна присутствуют кнопки **LPS**, **GPS** и **OPT**. Каждая из них загружает в квадрокоптер стандартный набор параметров для полета, соответственно, в локальной системе позиционирования (Локус/ИК), с использованием модуля GPS/ГЛОНАСС и модуля оптического позиционирования. 

.. note:: Если вы хотите вернуться к заводским настройкам, нажмите кнопку **сбросить по умолчанию** над таблицей и подождите пока "Пионер" перезапустится.

.. attention:: Актуальные параметры для Pioneer Max Вы можете скачать по ссылке ниже. Для корректной работы квадрокоптера обязательно загрузите данные параметры в автопилот квадрокоптера.


* `Параметры АП для Pioneer Max <https://disk.yandex.ru/d/IrWVG9xBmZaenw>`__

* `Параметры АП для Pioneer Max ROS <https://drive.google.com/uc?export=download&confirm=no_antivirus&id=1h7_B2DjN7hiN_PCSxYsdqPgXFBfr_AHK>`__

________

Настройка режима "Возврат домой"
--------------------------------

В Пионере предусмотрен режим возврата домой (RTL) в экстренных ситуациях. Домашней точкой считается место, где был произведён запуск двигателей. Квадрокоптер перейдёт в режим возврата в следующих случаях:

* При низком заряде на аккумуляторе
* При отсутствии сигнала от системы навигации
* При отсутствии сигала c пульта радиоуправления

В автопилоте режим RTL настраивается с помощью следующих параметров:

* **Flight_com_navSystem** - параметр указывает какую систему навигации следует использовать при полёте. При значении 0 – используется GNSS (спутниковая система навигации). При значении 1 – локальная система (в случае использовании модуля ИК-навигации или системы Геоскан Локус). При значении 2 – квадрокоптер будет использовать модуль оптического позиционирования.
* **Flight_com_rtlVoltage** - параметр устанавливает напряжение в V ниже которого включается возврат домой. Для отключения возврата по напряжению параметр необходимо установить в 0. Событие о низком напряжении генерируется в течении полёта однократно.
* **Flight_com_landingVol** - параметр задаёт напряжение ниже которого производится экстренная посадка. Стоит учитывать, что посадка будет произведена, прервав возврат домой, где бы ни находился квадрокоптер, если напряжение опустится ниже указанного.
* **Flight_com_autoFlightT** - параметр задаёт длительность автоматического полёта. Полёт считается автоматическим в случае пропадания связи с пультом радиоуправления.  
* **Copter_flyWithoutRc** - параметр позволяющий запускать квадрокоптер автономно без пульта радиоуправления. Автопилот не начнёт выполнять скрипт в случае, если пульт ДУ не связан с приёмником или выключен (значение 1) или проигнорирует его отсутствие (значение 0).
* **Flight_com_landAtHome** - включение посадки при возврате домой. Данный параметр определяет, надо ли садиться при достижении точки дома в режиме возврата (значение 1) или нужно зависнуть над точкой дома (значение 0).
* **Flight_com_homeAlt** - высота над точкой дома в метрах, использующаяся в режиме возврата домой. Коптер зависнет на этой высоте над точкой дома.
* **Flight_com_rtlAltMode** - параметр определяющий режим возврата домой. Квадрокоптер долетит до точки дома с удержанием высоты, после чего совершит посадку (значение 0), либо будет постепенно снижаться при возврате (значение 1).
* **Flight_com_returnAlt** - высота возврата в домашнюю точку.

________

Настройка параметров при замене на не заводские моторы
------------------------------------------------------

Если вы заменили двигатели на Пионере, они могут отличаться по электрическим характеристикам и не пройдут предстартовые проверки при подготовке к взлёту. За неё отвечают параметры:

* **Copter_motorCheckTime** - время проверки скорости оборотов двигателей на старте в секундах. Для отключения проверки установите значение параметра 0 
* **Copter_startRpmMax** - максимальное количество об/мин для проверки на старте
* **Copter_startRpmMin** - минимальное количество об/мин для проверки на старте
* **Copter_startRpmSigma** - максимальное расхождение между измеренными оборотами двигателей, при превышении которого считается, что двигатели работают неравномерно.

При получении команды на взлет (первые 5 секунд) проводится ещё одна проверка:

* **Copter_stallRpm** - предельная величина оборотов, после которой считается, что произошел срыв синхронизации, и двигатели отключаются. Для нестандартных двигателей можно использовать максимально возможные холостые обороты двигателя (для этого нужно умножить kv двигателя на напряжение аккумулятора)

В случае замены двигателей на более мощные вам также может понадобиться настроить PID коэффициенты. Неправильные PID  - причина заметных вибраций и колебаний коптера в полёте. 

Чтобы настроить PID коэффициенты, используйте следующие параметры:

* **Copter_xyRate_ki** - интегральная часть регулятора. Его нужно уменьшить, если квадрокоптер нехотя отзывается на управление, и увеличить, если заметны низкочастотные колебания.
* **Copter_xyRate_kp** - пропорциональная часть регулятора. Его можно уменьшить, если присутствует заметное перерегулирование и высокочастотные колебания (коптер дрожит во время зависания в одной точке). Если квадрокоптер плохо отзывается на управление, значение параметра нужно увеличить. 

.. note:: Для оценки допустимых оборотов, запишите логи полёта в ручном режиме управления и просмотрите график **rpm** в канале данных **motor-x**. Подробнее в разделе :doc:`logs`
