Обновление прошивки автопилота
==============================

.. danger:: Перед осуществлением первого полета, **обязательно обновите прошивку** и параметры автопилота "Пионера Мини". Полет с устаревшей версией прошивки автопилота ниже чем 1.6.7011 может быть небезопасен.

Для корректной работы всех систем "Пионера" рекомендуется устанавливать последнюю актуальную версию прошивки. Для этого на вашем компьютере должна быть установлена программа Pioneer Station. Если у вас ее нет, нажмите `скачать установщик Pioneer Station`_, загрузка начнется автоматически. После этого необходимо запустить скачанный exe файл.

.. note:: Внимание обновление! Последняя версия прошивки автопилота на данный момент 1.6.7481 с добавлением возможности программирования на Python и переходом на новый протокол. Об нововведениях в данной версии, читайте в конце данной страницы. Версия АП 1.6.7257 устарела.


.. _скачать установщик Pioneer Station: https://www.geoscan.aero/ru/products/pioneer/mini#pills-download

.. note:: Если вы пользователь квадрокоптер "Геоскан Пионер" и у вас уже есть данная программа, советуем ее еще раз скачать и обновить версию. Это необходимо для корректной работы. Версия Pioneer Station 1.10.0 более не актуальна. Необходима версия 1.11.0.


Пошаговая инструкция обновления версии автопилота "Пионера Мини"
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


1. Подключите квадрокоптер к компьютеру с помощью кабеля micro-USB входящий в комплект поставки. И запустите программу "Pioneer Station". Включите квадрокоптер нажав на кнопку сбоку. Левый светодиод сзади должен начать мигать.

.. figure:: media/onoffswitch.png
   :align: center

2. В левом нижнем углу нажмите кнопку **"Подключение"** и выберете **"По кабелю USB"**

.. figure:: media/firmware-step1.PNG
   :align: center

.. note:: Если по истечении 10 секунд окно программы не обновилось, попробуйте переподключить квадрокоптер и перезапустить программу. Если это не помогло, попробуйте `скачать и установить драйвер порта`_, после чего переподключите "Пионер Мини" и перезапустите программу.

3. В верхнем правом углу нажмите иконку **"квадрокоптера"** и выберете **"Обновление прошивки"**

.. figure:: media/firmware-step2.PNG
   :align: center

4. В открывшемся окне нажмите **"Далее"**, у Пионера Мини погаснет левый-задний светодиод статуса, это означает что квадрокоптер перешёл в режим обновления (загрузчика/бутлоадера).


5. В следующем окне нажмите **"Обновить"** и выберете модуль **"DFUPioneer-Mini-A"** это и есть базовая плата "Пионера Мини".

.. figure:: media/firmware-step3.PNG
   :align: center

.. note:: Если при выборе устройства квадрокоптер не отображается в окне, нажать кнопку "Обновить" еще раз.

6. В следующем окне нажмите **"Встроенный"** или **"Из файла"** и найдите файл с примерным названием **pioneer_mini_V1_1-boot-pioneer-1.6.74**.bin** Самое главное чтобы в названии файла было прописано *pioneer_mini* и версия прошивки *1.6.7481* или старше.

Если в вашей версии Pioneer Station не встроена актуальная прошивка, можете ее скачать вручную в папку с установленной программой PioneerStation/firmware


`Скачать прошивку автопилота 1.6.7481 <https://disk.yandex.ru/d/2lt2YDFPGsik-w?w=1>`__

Для работы с этой версией прошивки необходима новая версия приложения, при необходимости обновите.

:doc:`../flight/geoscan_jump`



.. figure:: media/save-stm.PNG
   :align: center

7. Нажмите "Прошить", обновление прошивки может занимать до нескольких минут в зависимости от вашего ПК.

.. attention:: Не прерывайте соединение USB между коптером и ПК во время обновления, это может привести к серьезным проблемам и временному выходу квадрокоптера из строя!

8. Дождитесь окончания прошивки, это может занять несколько минут. После завершения нажмите "ОК", после чего отключите питание (от USB и/или от аккумулятора) и затем заново включите квадрокоптер нажатием на кнопку на корпусе. Левый задний светодиод должен периодически мигать фиолетовым (или желтым) цветом.


9. Заново подключитесь к квадрокоптеру в стандартном режиме по USB и проверьте версию АП. Если все сделано правильно то в столбце *"Версия"* вы увидите значение не меньше чем *1.6.7481*.

10. Еще переподключите квадрокоптер нажатием на кнопку, на самом квадрокоптере. Должен исчезнуть отказ *RESTART_REQUIRED*

.. figure:: media/firmware-step4.PNG
   :align: center

11. После загрузки новой прошивки вам будет необходимо сначала загрузить параметры автопилота, а потом откалибровать акселерометр.

.. tip:: Если при после двух перезапусков в строке отказы в Pioneer Station, есть слова *RESTART_REQUIRED* и этот отказ не пропадает, то напишите нам в техническую поддержку.

.. _скачать и установить драйвер порта: https://www.silabs.com/products/development-tools/software/usb-to-uart-bridge-vcp-drivers

Если Вы столкнулись с проблемой обновления прошивки или работы "Пионера", напишите в тех. поддержку Геоскан support@geoscan.aero или `телеграмм аккаунт <https://t.me/geoscan_edu>`__ технической поддержки.

.. note:: отказ *UNPROTECTED* не влияет на полет, это служебное уведомление для разработчиков. На пользовательский опыт это никак не влияет.

.. note:: После обновления прошивки автопилота до более высокой версии, вам необходимо обновить параметры автопилота. Вы можете сделать это автоматически при обновлении второго контроллера ESP-32, либо вручную на странице
          :doc:`autopilot_parameters`. Стандартные параметры автопилота и "Пионера Мини" и обычного "Пионера" различаются имейте это в виду. Это связано с *различной электронной начинкой* квадрокоптеров. Также параметры непосредственно влияют на качество полета.

.. note:: Если у вас возникла ошибка "Ошибка подключения к НСУ", вы можете исправить ее через обновления параметров через ESPTOOL или воспользовавшись утилитой minipatcher:
          :doc:`..\..\..\mini-nsu`


Нововведения в прошивка автопилота
----------------------------------

Автопилот 1.6.7481
~~~~~~~~~~~~~~~~~~

#. Полностью перешли на новый протокол передачи данных MavLink для более стабильного соединения и управления;
#. Добавили возможность запускать/остановить lua-script в режиме program напрямую с мобильного телефона;
#. Улучшили работу с pioneer_sdk.

Автопилот 1.6.7459
~~~~~~~~~~~~~~~~~~

Добавлена возможность программирования квадрокоптера на языке Python. Для этого была специально разработана библиотека *pioneer_sdk*. Подробное описание на странице :doc:`..\..\..\programming\python\python_main`

Автопилот 1.6.7257
~~~~~~~~~~~~~~~~~~

* Добавлен режим "Failsafe" (экстренной посадки). Квадрокоптер будет совершать автоматическую посадку под собой в месте возникновения неполадки.

  Данный режим будет включаться автоматически при следующих условиях:

  * Разорвалось WiFi соединение;
  * Произошло зависание контроллера ESP32;
  * Превышены задержки в связи между квадрокоптером и телефоном;
  * Закрылось приложение JUMP;
  * Телефон выключился/заблокировался.

  "Failsafe" работает в двух режимах:

  1) С посадкой в точку под собой, где произошла неполадка (по умолчанию, рекомендуемый).

  2) С посадкой в точку взлета с некоторой точностью (отклонение от точки взлета около 1.5 метра) (экспериментальный, использовать с осторожностью. Квадрокоптер летит автономно, препятствия не огибает.)

* Восстановлена корректная работа программируемых RGB светодиодов. Попробуйте встроенные примеры в программе **"Pioneer Station"**

* При включение квадрокоптера, 4 RGB светодиода будут показывать уровень заряда, красный аккумулятор заряжен, ярко-зеленый аккумулятор заряжен.


Автопилот 1.6.7011
~~~~~~~~~~~~~~~~~~

Стабильная версия, устарела.